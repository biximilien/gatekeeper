version: "3.5"

services:
  gateway:
    image: openresty/openresty:centos
    volumes:
      - ${PWD}/config/gateway/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      - ${PWD}/lua:/scripts:ro
    depends_on:
      - redis01
    links:
      - redis01
      - db
      - web01
      - web02
      - web03
      - api01
      - api02
      - api03
    ports:
      - "8081:80"

  redis01:
    image: redis

  db:
    image: postgres

  grafana:
    image: grafana/grafana
    links:
      - db
    ports:
      - "3000:3000"

  broker:
    image: rabbitmq:management

  web01:
    image: nginx
    volumes:
      - ${PWD}/www/apps/web:/usr/share/nginx/html:ro

  web02:
    image: nginx
    volumes:
      - ${PWD}/www/apps/web:/usr/share/nginx/html:ro

  web03:
    image: nginx
    volumes:
      - ${PWD}/www/apps/web:/usr/share/nginx/html:ro

  api01:
    image: golang
    command: go run /src/github.com/jaswdr/template/main.go
    volumes:
      - ${PWD}/www/apps/api:/src/github.com/jaswdr/template:ro

  api02:
    image: golang
    command: go run /src/github.com/jaswdr/template/main.go
    volumes:
      - ${PWD}/www/apps/api:/src/github.com/jaswdr/template:ro

  api03:
    image: golang
    command: go run /src/github.com/jaswdr/template/main.go
    volumes:
      - ${PWD}/www/apps/api:/src/github.com/jaswdr/template:ro
