version: "3.5"

services:
  gateway:
    image: openresty/openresty:centos
    volumes:
      - ${PWD}/config/gateway/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      - ${PWD}/lua:/scripts:ro
    depends_on:
      - redis01
    links:
      - grafana
      - redis01
      - db
      - web01
      - web02
      - web03
      - api01
      - api02
      - api03
    ports:
      - "8081:80"
      - "3000:3000"

  redis01:
    image: redis

  db:
    image: postgres

  grafana:
    image: grafana/grafana
    environment:
      - GF_DATABASE_URL=postgres://postgres:postgres@db:5432/postgres
      - GF_DATABASE_SSL_MODE=disable
      - GF_SESSION_PROVIDER=redis
      - GF_SESSION_PROVIDER_CONFIG=addr=redis01:6379,pool_size=100,db=grafana
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_LOGIN_REMEMBER_DAYS=7
      - GF_SECURITY_DISABLE_GRAVATAR=true
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
    links:
      - db
      - redis01

  broker:
    image: rabbitmq:management

  web01:
    image: nginx
    volumes:
      - ${PWD}/www/apps/web:/usr/share/nginx/html:ro

  web02:
    image: nginx
    volumes:
      - ${PWD}/www/apps/web:/usr/share/nginx/html:ro

  web03:
    image: nginx
    volumes:
      - ${PWD}/www/apps/web:/usr/share/nginx/html:ro

  api01:
    image: golang
    command: go run /src/github.com/jaswdr/template/main.go
    volumes:
      - ${PWD}/www/apps/api:/src/github.com/jaswdr/template:ro

  api02:
    image: golang
    command: go run /src/github.com/jaswdr/template/main.go
    volumes:
      - ${PWD}/www/apps/api:/src/github.com/jaswdr/template:ro

  api03:
    image: golang
    command: go run /src/github.com/jaswdr/template/main.go
    volumes:
      - ${PWD}/www/apps/api:/src/github.com/jaswdr/template:ro
